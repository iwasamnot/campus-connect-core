rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    // More robust: checks if user document exists and has admin role
    function isAdmin() {
      return request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role != null &&
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin1');
    }
    
    // Helper function to check if user is authenticated (no email verification required)
    function isAuthenticated() {
      return request.auth != null;
    }

    // Users collection
    match /users/{userId} {
      // Allow authenticated users to read user profiles
      allow read: if isAuthenticated();
      
      // Allow users to create their own user document
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Allow users to update their own profile, or admins to update any user
      allow update: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }

    // Messages collection (Campus Chat)
    match /messages/{messageId} {
      // Allow all authenticated users to read messages (no email verification check)
      allow read: if isAuthenticated();
      
      // Allow authenticated users to create messages
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Allow users to update their own messages, or admins to update any message
      // Also allow updating reactions, readBy, attachments, replies, mentions, toxicity, pinned fields
      allow update: if isAuthenticated() && (
        request.resource.data.userId == request.auth.uid ||
        isAdmin() ||
        // Allow updating reactions field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions']) ||
        // Allow updating readBy field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy']) ||
        // Allow updating attachment field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attachment']) ||
        // Allow updating replyTo, replyToText, replyToUserName fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['replyTo', 'replyToText', 'replyToUserName']) ||
        // Allow updating mentions field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['mentions']) ||
        // Allow updating toxicity fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['toxicityConfidence', 'toxicityReason', 'toxicityMethod', 'toxicityCategories']) ||
        // Allow updating pinned fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['pinned', 'pinnedAt'])
      );
      
      // Allow message authors and admins to delete messages
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }

    // Group messages collection
    match /groupMessages/{messageId} {
      // Allow all authenticated users to read group messages
      allow read: if isAuthenticated();
      
      // Allow authenticated users to create group messages
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Allow users to update their own messages, or admins to update any message
      allow update: if isAuthenticated() && (
        request.resource.data.userId == request.auth.uid ||
        isAdmin() ||
        // Allow updating reactions field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions']) ||
        // Allow updating readBy field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy']) ||
        // Allow updating attachment field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attachment']) ||
        // Allow updating replyTo, replyToText, replyToUserName fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['replyTo', 'replyToText', 'replyToUserName']) ||
        // Allow updating mentions field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['mentions']) ||
        // Allow updating toxicity fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['toxicityConfidence', 'toxicityReason', 'toxicityMethod', 'toxicityCategories'])
      );
      
      // Allow message authors and admins to delete messages
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }

    // Private chats collection
    match /privateChats/{chatId} {
      // Allow authenticated users to read chats they're part of
      allow read: if isAuthenticated() && 
        request.auth.uid in resource.data.participants;
      
      // Allow authenticated users to create chats they're part of
      allow create: if isAuthenticated() && 
        request.auth.uid in request.resource.data.participants;
      
      // Allow participants to update chats
      allow update: if isAuthenticated() && 
        request.auth.uid in resource.data.participants;
      
      // Allow participants to delete chats
      allow delete: if isAuthenticated() && 
        request.auth.uid in resource.data.participants;

      // Private chat messages subcollection
      match /messages/{messageId} {
        // Allow authenticated participants to read messages
        allow read: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/privateChats/$(chatId)).data.participants;
        
        // Allow authenticated participants to create messages
        allow create: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/privateChats/$(chatId)).data.participants &&
          request.resource.data.userId == request.auth.uid;
        
        // Allow users to update their own messages, or admins to update any message
        allow update: if isAuthenticated() && (
          request.auth.uid in get(/databases/$(database)/documents/privateChats/$(chatId)).data.participants &&
          (request.resource.data.userId == request.auth.uid ||
           isAdmin() ||
           // Allow updating reactions field
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions']) ||
           // Allow updating readBy field
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy']) ||
           // Allow updating attachment field
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attachment']) ||
           // Allow updating replyTo, replyToText, replyToUserName fields
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['replyTo', 'replyToText', 'replyToUserName']) ||
           // Allow updating mentions field
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['mentions']) ||
           // Allow updating toxicity fields
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['toxicityConfidence', 'toxicityReason', 'toxicityMethod', 'toxicityCategories']) ||
           // Allow updating disappearing message fields
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['expiresAt', 'disappearingMessageDuration']))
        );
        
        // Allow message authors and admins to delete messages
        allow delete: if isAuthenticated() && (
          request.auth.uid in get(/databases/$(database)/documents/privateChats/$(chatId)).data.participants &&
          (resource.data.userId == request.auth.uid || isAdmin())
        );
      }
    }

    // Groups collection
    match /groups/{groupId} {
      // Allow all authenticated users to read groups (for browsing)
      allow read: if isAuthenticated();
      
      // Allow authenticated users to create groups
      allow create: if isAuthenticated() && 
        request.resource.data.creator == request.auth.uid &&
        request.auth.uid in request.resource.data.members &&
        request.auth.uid in request.resource.data.admins;
      
      // Allow group admins to update groups, or users to add themselves to joinRequests
      allow update: if isAuthenticated() && (
        request.auth.uid in resource.data.admins ||
        // Allow users to add themselves to joinRequests
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['joinRequests']) &&
        request.auth.uid in request.resource.data.joinRequests
      );
      
      // Allow group admins to delete groups
      allow delete: if isAuthenticated() && 
        request.auth.uid in resource.data.admins;

      // Join requests subcollection
      match /joinRequests/{requestId} {
        // Allow users to read their own requests, or group admins to read all requests
        allow read: if isAuthenticated() && 
          (request.auth.uid == resource.data.userId ||
           request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.admins);
        
        // Allow authenticated users to create join requests
        allow create: if isAuthenticated() && 
          request.resource.data.userId == request.auth.uid;
        
        // Allow group admins to update join requests
        allow update: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.admins;
        
        // Allow users to delete their own requests, or group admins to delete any request
        allow delete: if isAuthenticated() && 
          (request.auth.uid == resource.data.userId ||
           request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.admins);
      }
    }

    // Reports collection
    match /reports/{reportId} {
      // Only admins can read reports
      allow read: if isAdmin();
      
      // All authenticated users can create reports
      allow create: if isAuthenticated();
      
      // Only admins can update reports
      allow update: if isAdmin();
      
      // Only admins can delete reports
      allow delete: if isAdmin();
    }

    // Audit logs collection
    match /auditLogs/{logId} {
      // Only admins can read audit logs
      allow read: if isAdmin();
      
      // Allow authenticated users to create audit logs (for logging actions)
      allow create: if isAuthenticated();
      
      // Audit logs should never be updated
      allow update: if false;
      
      // Only admins can delete audit logs
      allow delete: if isAdmin();
    }

    // Typing indicators collection
    match /typing/{userId} {
      // Allow all authenticated users to read typing indicators
      allow read: if isAuthenticated();
      
      // Allow users to create their own typing indicator
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Allow users to update their own typing indicator
      allow update: if isAuthenticated() && request.auth.uid == userId;
      
      // Allow users to delete their own typing indicator
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }

    // Pinned messages collection (if used as separate collection)
    match /pinnedMessages/{messageId} {
      // Allow all authenticated users to read pinned messages
      allow read: if isAuthenticated();
      
      // Allow authenticated users to create pinned messages
      allow create: if isAuthenticated();
      
      // Allow message authors and admins to update pinned messages
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      // Allow message authors and admins to delete pinned messages
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }

    // Saved messages collection
    match /savedMessages/{savedMessageId} {
      // Allow users to read their own saved messages
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Allow authenticated users to create saved messages for themselves
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Allow users to update their own saved messages
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Allow users to delete their own saved messages
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }

    // Scheduled messages collection
    match /scheduledMessages/{scheduledMessageId} {
      // Allow users to read their own scheduled messages
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Allow authenticated users to create scheduled messages for themselves
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Allow users to update their own scheduled messages
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Allow users to delete their own scheduled messages, or admins to delete any
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }
  }
}
