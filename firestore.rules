rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    // More robust: checks if user document exists and has admin role
    // Returns false (not admin) if user document doesn't exist yet (prevents errors)
    function isAdmin() {
      return request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role != null &&
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin1');
    }
    
    // Helper function to check if user is authenticated (no email verification required)
    function isAuthenticated() {
      return request.auth != null;
    }

    // Users collection
    match /users/{userId} {
      // Allow authenticated users to read user profiles
      allow read: if isAuthenticated();
      
      // Allow users to create their own user document (can set role and emailVerified on creation)
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Allow users to update their own profile, or admins to update any user
      // IMPORTANT: 
      // - Users can SET their role if it doesn't exist yet (first time login) OR if document doesn't exist
      // - Users can update emailVerified from false/undefined to true (when they verify email)
      // - Users CANNOT change their role after it's been set - only admins can
      // - Users CANNOT change emailVerified from true to false - only admins can
      // - Users can update isOnline and lastSeen for presence tracking (always allowed)
      allow update: if isAuthenticated() && (
        // Admin updating any user (can update emailVerified and role freely)
        isAdmin() ||
        // User updating their own profile
        (request.auth.uid == userId && (
          // Always allow updating presence fields (isOnline, lastSeen) - most common operation
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isOnline', 'lastSeen'])) ||
          // Allow updating presence fields with other non-restricted fields
          (request.resource.data.diff(resource.data).affectedKeys().hasAll(['isOnline', 'lastSeen']) &&
           !request.resource.data.diff(resource.data).affectedKeys().hasAny(['emailVerified', 'role'])) ||
          // Allow updating fields other than role and emailVerified
          (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['emailVerified', 'role'])) ||
          // Allow setting role ONLY if it doesn't exist yet (first time setup during login)
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['role']) &&
           !('role' in resource.data)) ||
          // Allow updating emailVerified from false/undefined to true (user verified their email)
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['emailVerified']) &&
           request.resource.data.emailVerified == true &&
           (!('emailVerified' in resource.data) || resource.data.emailVerified == false)) ||
          // Allow setting both role and emailVerified if role doesn't exist (first login)
          (request.resource.data.diff(resource.data).affectedKeys().hasAll(['role', 'emailVerified']) &&
           !('role' in resource.data)) ||
          // Allow creating document with presence fields and other initial fields (when document doesn't exist)
          (!exists(/databases/$(database)/documents/users/$(userId)) &&
           request.resource.data.isOnline != null &&
           request.resource.data.lastSeen != null)
        ))
      );
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }

    // Messages collection (Campus Chat)
    match /messages/{messageId} {
      // Allow all authenticated users to read messages (no email verification check)
      allow read: if isAuthenticated();
      
      // Allow authenticated users to create messages
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Allow users to update their own messages, or admins to update any message
      // Also allow updating reactions, readBy, attachments, replies, mentions, toxicity, pinned fields
      allow update: if isAuthenticated() && (
        request.resource.data.userId == request.auth.uid ||
        isAdmin() ||
        // Allow updating reactions field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions']) ||
        // Allow updating readBy field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy']) ||
        // Allow updating attachment field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attachment']) ||
        // Allow updating replyTo, replyToText, replyToUserName fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['replyTo', 'replyToText', 'replyToUserName']) ||
        // Allow updating mentions field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['mentions']) ||
        // Allow updating toxicity fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['toxicityConfidence', 'toxicityReason', 'toxicityMethod', 'toxicityCategories']) ||
        // Allow updating pinned fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['pinned', 'pinnedAt'])
      );
      
      // Allow message authors and admins to delete messages
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }

    // Group messages collection
    match /groupMessages/{messageId} {
      // Allow all authenticated users to read group messages
      allow read: if isAuthenticated();
      
      // Allow authenticated users to create group messages
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Allow users to update their own messages, or admins to update any message
      allow update: if isAuthenticated() && (
        request.resource.data.userId == request.auth.uid ||
        isAdmin() ||
        // Allow updating reactions field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions']) ||
        // Allow updating readBy field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy']) ||
        // Allow updating attachment field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attachment']) ||
        // Allow updating replyTo, replyToText, replyToUserName fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['replyTo', 'replyToText', 'replyToUserName']) ||
        // Allow updating mentions field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['mentions']) ||
        // Allow updating toxicity fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['toxicityConfidence', 'toxicityReason', 'toxicityMethod', 'toxicityCategories'])
      );
      
      // Allow message authors and admins to delete messages
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }

    // Private chats collection
    match /privateChats/{chatId} {
      // Allow authenticated users to read chats they're part of
      // Also allow reading non-existent documents (for checking if chat exists before creating)
      allow read: if isAuthenticated() && (
        !exists(/databases/$(database)/documents/privateChats/$(chatId)) ||
        (resource.data.participants != null &&
         request.auth.uid in resource.data.participants)
      );
      
      // Allow authenticated users to create chats they're part of
      allow create: if isAuthenticated() && 
        request.resource.data.participants != null &&
        request.auth.uid in request.resource.data.participants;
      
      // Allow participants to update chats (for lastMessage, lastMessageTime, disappearing messages settings)
      allow update: if isAuthenticated() && 
        resource.data.participants != null &&
        request.auth.uid in resource.data.participants &&
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastMessage', 'lastMessageTime', 'disappearingMessagesEnabled', 'disappearingMessagesDuration']) ||
         isAdmin());
      
      // Allow participants to delete chats
      allow delete: if isAuthenticated() && 
        resource.data.participants != null &&
        request.auth.uid in resource.data.participants;

      // Private chat messages subcollection
      match /messages/{messageId} {
        // Allow authenticated participants to read messages
        allow read: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/privateChats/$(chatId)).data.participants;
        
        // Allow authenticated participants to create messages
        allow create: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/privateChats/$(chatId)).data.participants &&
          request.resource.data.userId == request.auth.uid;
        
        // Allow users to update their own messages, or admins to update any message
        allow update: if isAuthenticated() && (
          request.auth.uid in get(/databases/$(database)/documents/privateChats/$(chatId)).data.participants &&
          (request.resource.data.userId == request.auth.uid ||
           isAdmin() ||
           // Allow updating reactions field
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions']) ||
           // Allow updating readBy field
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy']) ||
           // Allow updating attachment field
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attachment']) ||
           // Allow updating replyTo, replyToText, replyToUserName fields
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['replyTo', 'replyToText', 'replyToUserName']) ||
           // Allow updating mentions field
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['mentions']) ||
           // Allow updating toxicity fields
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['toxicityConfidence', 'toxicityReason', 'toxicityMethod', 'toxicityCategories']) ||
           // Allow updating disappearing message fields
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['expiresAt', 'disappearingMessageDuration']))
        );
        
        // Allow message authors and admins to delete messages
        allow delete: if isAuthenticated() && (
          request.auth.uid in get(/databases/$(database)/documents/privateChats/$(chatId)).data.participants &&
          (resource.data.userId == request.auth.uid || isAdmin())
        );
      }
    }

    // Groups collection
    match /groups/{groupId} {
      // Allow all authenticated users to read groups (for browsing)
      allow read: if isAuthenticated();
      
      // Allow authenticated users to create groups
      allow create: if isAuthenticated() && 
        (request.resource.data.createdBy == request.auth.uid || request.resource.data.creator == request.auth.uid) &&
        request.auth.uid in request.resource.data.members &&
        request.auth.uid in request.resource.data.admins;
      
      // Allow group admins to update groups, or users to add themselves to joinRequests
      // Also allow members to leave groups (remove themselves from members/admins)
      allow update: if isAuthenticated() && (
        request.auth.uid in resource.data.admins ||
        // Allow users to add themselves to joinRequests
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['joinRequests']) &&
         request.auth.uid in request.resource.data.joinRequests) ||
        // Allow members to leave groups (remove themselves from members and admins)
        (request.resource.data.diff(resource.data).affectedKeys().hasAny(['members', 'admins']) &&
         !(request.auth.uid in request.resource.data.members) &&
         request.auth.uid in resource.data.members)
      );
      
      // Allow group admins to delete groups
      allow delete: if isAuthenticated() && 
        request.auth.uid in resource.data.admins;

      // Join requests subcollection
      match /joinRequests/{requestId} {
        // Allow users to read their own requests, or group admins to read all requests
        allow read: if isAuthenticated() && 
          (request.auth.uid == resource.data.userId ||
           request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.admins);
        
        // Allow authenticated users to create join requests
        allow create: if isAuthenticated() && 
          request.resource.data.userId == request.auth.uid;
        
        // Allow group admins to update join requests
        allow update: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.admins;
        
        // Allow users to delete their own requests, or group admins to delete any request
        allow delete: if isAuthenticated() && 
          (request.auth.uid == resource.data.userId ||
           request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.admins);
      }
    }

    // Reports collection
    match /reports/{reportId} {
      // Only admins can read reports
      allow read: if isAdmin();
      
      // All authenticated users can create reports
      allow create: if isAuthenticated();
      
      // Only admins can update reports
      allow update: if isAdmin();
      
      // Only admins can delete reports
      allow delete: if isAdmin();
    }

    // Audit logs collection
    match /auditLogs/{logId} {
      // Only admins can read audit logs
      allow read: if isAdmin();
      
      // Allow authenticated users to create audit logs (for logging actions)
      allow create: if isAuthenticated();
      
      // Audit logs should never be updated
      allow update: if false;
      
      // Only admins can delete audit logs
      allow delete: if isAdmin();
    }

    // Typing indicators collection
    match /typing/{userId} {
      // Allow all authenticated users to read typing indicators
      allow read: if isAuthenticated();
      
      // Allow users to create their own typing indicator
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Allow users to update their own typing indicator
      allow update: if isAuthenticated() && request.auth.uid == userId;
      
      // Allow users to delete their own typing indicator
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }

    // Pinned messages collection (if used as separate collection)
    match /pinnedMessages/{messageId} {
      // Allow all authenticated users to read pinned messages
      allow read: if isAuthenticated();
      
      // Allow authenticated users to create pinned messages
      allow create: if isAuthenticated();
      
      // Allow message authors and admins to update pinned messages
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      // Allow message authors and admins to delete pinned messages
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }

    // Saved messages collection
    match /savedMessages/{savedMessageId} {
      // Allow users to read their own saved messages
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Allow authenticated users to create saved messages for themselves
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Allow users to update their own saved messages
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Allow users to delete their own saved messages
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }

    // Scheduled messages collection
    match /scheduledMessages/{scheduledMessageId} {
      // Allow users to read their own scheduled messages
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Allow authenticated users to create scheduled messages for themselves
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Allow users to update their own scheduled messages
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Allow users to delete their own scheduled messages, or admins to delete any
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }

    // Call notifications collection
    match /callNotifications/{notificationId} {
      // Allow users to read notifications sent to them
      allow read: if isAuthenticated() && 
        resource.data.to == request.auth.uid;
      
      // Allow authenticated users to create call notifications
      allow create: if isAuthenticated() && 
        request.resource.data.from == request.auth.uid;
      
      // Allow users to update notifications sent to them (for status changes)
      allow update: if isAuthenticated() && 
        resource.data.to == request.auth.uid;
      
      // Allow users to delete notifications sent to them, or the sender to delete their own notifications
      allow delete: if isAuthenticated() && (
        resource.data.to == request.auth.uid ||
        resource.data.from == request.auth.uid
      );
    }

    // Contact messages collection (messages from non-users to admin)
    match /contactMessages/{messageId} {
      // Only admins can read contact messages
      allow read: if isAdmin();
      
      // Allow anyone (including non-authenticated users) to create contact messages
      allow create: if request.resource.data.name != null &&
                     request.resource.data.email != null &&
                     request.resource.data.message != null &&
                     request.resource.data.timestamp != null &&
                     request.resource.data.status == 'new' &&
                     request.resource.data.isFromNonUser == true;
      
      // Only admins can update contact messages (for status changes)
      allow update: if isAdmin();
      
      // Only admins can delete contact messages
      allow delete: if isAdmin();
    }

    // Visual Boards collection (collaborative whiteboards)
    match /visualBoards/{boardId} {
      // Allow authenticated users to read boards they're participants in
      allow read: if isAuthenticated() && 
        (resource.data.participants != null && 
         request.auth.uid in resource.data.participants);
      
      // Allow authenticated users to create boards (must include themselves as participant)
      allow create: if isAuthenticated() && 
        request.resource.data.participants != null &&
        request.auth.uid in request.resource.data.participants;
      
      // Allow participants to update boards
      allow update: if isAuthenticated() && 
        resource.data.participants != null &&
        request.auth.uid in resource.data.participants;
      
      // Allow participants to delete boards
      allow delete: if isAuthenticated() && 
        resource.data.participants != null &&
        request.auth.uid in resource.data.participants;

      // Cursors subcollection (for real-time cursor positions)
      match /cursors/{userId} {
        // Allow authenticated users to read all cursors in a board they're part of
        allow read: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/visualBoards/$(boardId)).data.participants;
        
        // Allow users to create/update their own cursor
        allow create, update: if isAuthenticated() && 
          request.auth.uid == userId &&
          request.auth.uid in get(/databases/$(database)/documents/visualBoards/$(boardId)).data.participants;
        
        // Allow users to delete their own cursor
        allow delete: if isAuthenticated() && request.auth.uid == userId;
      }
    }

    // Admin support chat collection (live chat between users and admins)
    // IMPORTANT: Allows unauthenticated users to contact admins in real-time
    match /adminSupportChat/{messageId} {
      // Admins can read all messages
      // Authenticated users can read their own messages (by userId or email)
      // Unauthenticated users can read ALL messages in their thread (both user and admin messages)
      // This allows back-and-forth conversation
      allow read: if (
        // Admin can read all messages
        (isAuthenticated() && isAdmin()) ||
        // Authenticated user reading messages in their thread (both user and admin messages)
        (isAuthenticated() && (
          (resource.data.userEmail != null && 
           resource.data.userEmail == request.auth.token.email) ||
          (resource.data.userId != null && 
           resource.data.userId == request.auth.uid)
        )) ||
        // Unauthenticated user reading messages in their thread
        // Can read BOTH user messages (isFromUser) AND admin replies (isFromAdmin)
        // The query filters by userEmail, so they only see their own thread
        (request.auth == null && 
         resource.data.userEmail != null)
      );
      
      // Allow both authenticated and unauthenticated users to create messages
      // Admins can create admin messages
      allow create: if (
        // Admin creating admin message (must be authenticated)
        (isAuthenticated() && 
         isAdmin() &&
         request.resource.data.isFromAdmin == true &&
         request.resource.data.isFromUser == false &&
         request.resource.data.userId != null &&
         request.resource.data.userEmail != null) ||
        // User creating their own message (authenticated or unauthenticated)
        (request.resource.data.isFromUser == true &&
         request.resource.data.isFromAdmin == false &&
         request.resource.data.userEmail != null &&
         request.resource.data.text != null &&
         request.resource.data.timestamp != null &&
         // If authenticated, userId must match
         // If unauthenticated, userId can be a guest ID (format: guest-email)
         (request.auth == null || 
          request.resource.data.userId == request.auth.uid ||
          (request.resource.data.userId != null && 
           request.resource.data.userId.size() > 6 &&
           request.resource.data.userId[0:6] == 'guest-')))
      );
      
      // Users can update their own messages (for editing)
      // Admins can update any message
      // Also allow updating read status
      allow update: if (
        // Admin can update any message
        (isAuthenticated() && isAdmin()) ||
        // Authenticated user updating their own message
        (isAuthenticated() && 
         ((resource.data.userId == request.auth.uid ||
           resource.data.userEmail == request.auth.token.email) &&
          request.resource.data.userId == resource.data.userId &&
          request.resource.data.userEmail == resource.data.userEmail)) ||
        // Unauthenticated user updating their own message (by email)
        (request.auth == null &&
         resource.data.userEmail != null &&
         request.resource.data.userEmail == resource.data.userEmail &&
         request.resource.data.isFromUser == true) ||
        // Allow updating read status (anyone can mark as read)
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read'])
      );
      
      // Users can delete their own messages
      // Admins can delete any message
      allow delete: if (
        // Admin can delete any message
        (isAuthenticated() && isAdmin()) ||
        // Authenticated user deleting their own message
        (isAuthenticated() && 
         (resource.data.userId == request.auth.uid ||
          resource.data.userEmail == request.auth.token.email)) ||
        // Unauthenticated user deleting their own message (by email)
        (request.auth == null &&
         resource.data.userEmail != null &&
         resource.data.isFromUser == true)
      );
    }
    
    // Polls collection (for Campus Chat)
    match /polls/{pollId} {
      // Allow authenticated users to read polls
      allow read: if isAuthenticated();
      
      // Allow authenticated users to create polls
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Allow poll creator or admins to update polls (voting, closing)
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      // Allow poll creator or admins to delete polls
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Group polls collection
    match /groupPolls/{pollId} {
      // Allow authenticated users to read polls
      allow read: if isAuthenticated();
      
      // Allow authenticated users to create polls in groups
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Allow poll creator or admins to update polls
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      // Allow poll creator or admins to delete polls
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Quick replies / Message templates collection
    match /quickReplies/{templateId} {
      // Allow users to read their own templates
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Allow authenticated users to create their own templates
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Allow users to update their own templates
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Allow users to delete their own templates
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // User status updates collection
    match /userStatus/{statusId} {
      // Allow authenticated users to read status updates
      allow read: if isAuthenticated();
      
      // Allow authenticated users to create their own status updates
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Allow users to update their own status updates
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Allow users to delete their own status updates
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // Admin announcements collection
    match /announcements/{announcementId} {
      // Allow authenticated users to read announcements
      allow read: if isAuthenticated();
      
      // Only admins can create announcements
      allow create: if isAdmin();
      
      // Only admins can update announcements
      allow update: if isAdmin();
      
      // Only admins can delete announcements
      allow delete: if isAdmin();
    }
    
    // Knowledge base collection (for RAG system)
    match /knowledgeBase/{documentId} {
      // Allow all authenticated users to read knowledge base documents
      allow read: if isAuthenticated();
      
      // Only admins can create/update knowledge base documents
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Nearby chat presence collection (for offline proximity chat)
    match /nearbyPresence/{userId} {
      // Allow authenticated users to read nearby presence
      allow read: if isAuthenticated();
      
      // Allow users to create/update their own presence
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && request.auth.uid == userId;
      
      // Allow users to delete their own presence
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Collaborative documents collection
    match /collaborativeDocuments/{documentId} {
      // Allow authenticated users to read collaborative documents
      allow read: if isAuthenticated();
      
      // Allow authenticated users to create collaborative documents
      allow create: if isAuthenticated();
      
      // Allow authenticated users to update collaborative documents
      allow update: if isAuthenticated();
      
      // Allow document creators or admins to delete
      allow delete: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );
    }
    
    // User profiles for AI context
    match /userProfiles/{userId} {
      // Users can only read/write their own profile
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // App configuration collection (admin-only settings)
    match /appConfig/{configId} {
      // Only admins can read app configuration
      allow read: if isAdmin();
      
      // Only admins can create/update app configuration
      allow create, update: if isAdmin();
      
      // Only admins can delete app configuration
      allow delete: if isAdmin();
    }
  }
}
