rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role != null &&
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin1');
    }

    // Users collection
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow delete: if isAdmin();
    }

    // Messages collection (Campus Chat)
    match /messages/{messageId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && (
        request.resource.data.userId == request.auth.uid ||
        isAdmin() ||
        // Allow updating reactions field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions']) ||
        // Allow updating readBy field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy']) ||
        // Allow updating attachment field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attachment']) ||
        // Allow updating replyTo, replyToText, replyToUserName fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['replyTo', 'replyToText', 'replyToUserName']) ||
        // Allow updating mentions field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['mentions']) ||
        // Allow updating toxicity fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['toxicityConfidence', 'toxicityReason', 'toxicityMethod', 'toxicityCategories']) ||
        // Allow updating pinned fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['pinned', 'pinnedAt'])
      );
      allow delete: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }

    // Group messages collection
    match /groupMessages/{messageId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && (
        request.resource.data.userId == request.auth.uid ||
        isAdmin() ||
        // Allow updating reactions field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions']) ||
        // Allow updating readBy field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy']) ||
        // Allow updating attachment field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attachment']) ||
        // Allow updating replyTo, replyToText, replyToUserName fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['replyTo', 'replyToText', 'replyToUserName']) ||
        // Allow updating mentions field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['mentions']) ||
        // Allow updating toxicity fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['toxicityConfidence', 'toxicityReason', 'toxicityMethod', 'toxicityCategories'])
      );
      allow delete: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }

    // Private chats collection
    match /privateChats/{chatId} {
      allow read: if request.auth != null && 
        request.auth.uid in resource.data.participants;
      allow create: if request.auth != null && 
        request.auth.uid in request.resource.data.participants;
      allow update: if request.auth != null && 
        request.auth.uid in resource.data.participants;
      allow delete: if request.auth != null && 
        request.auth.uid in resource.data.participants;

      // Private chat messages subcollection
      match /messages/{messageId} {
        allow read: if request.auth != null && 
          request.auth.uid in get(/databases/$(database)/documents/privateChats/$(chatId)).data.participants;
        allow create: if request.auth != null && 
          request.auth.uid in get(/databases/$(database)/documents/privateChats/$(chatId)).data.participants &&
          request.resource.data.userId == request.auth.uid;
        allow update: if request.auth != null && (
          request.auth.uid in get(/databases/$(database)/documents/privateChats/$(chatId)).data.participants &&
          (request.resource.data.userId == request.auth.uid ||
           isAdmin() ||
           // Allow updating reactions field
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions']) ||
           // Allow updating readBy field
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy']) ||
           // Allow updating attachment field
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attachment']) ||
           // Allow updating replyTo, replyToText, replyToUserName fields
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['replyTo', 'replyToText', 'replyToUserName']) ||
           // Allow updating mentions field
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['mentions']) ||
           // Allow updating toxicity fields
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['toxicityConfidence', 'toxicityReason', 'toxicityMethod', 'toxicityCategories']) ||
           // Allow updating disappearing message fields
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['expiresAt', 'disappearingMessageDuration']))
        );
        allow delete: if request.auth != null && (
          request.auth.uid in get(/databases/$(database)/documents/privateChats/$(chatId)).data.participants &&
          (resource.data.userId == request.auth.uid || isAdmin())
        );
      }
    }

    // Groups collection
    match /groups/{groupId} {
      allow read: if request.auth != null; // All authenticated users can read groups (for browsing)
      allow create: if request.auth != null && 
        request.resource.data.creator == request.auth.uid &&
        request.auth.uid in request.resource.data.members &&
        request.auth.uid in request.resource.data.admins;
      allow update: if request.auth != null && (
        request.auth.uid in resource.data.admins ||
        // Allow users to add themselves to joinRequests
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['joinRequests']) &&
        request.auth.uid in request.resource.data.joinRequests
      );
      allow delete: if request.auth != null && 
        request.auth.uid in resource.data.admins;

      // Join requests subcollection
      match /joinRequests/{requestId} {
        allow read: if request.auth != null && 
          (request.auth.uid == resource.data.userId ||
           request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.admins);
        allow create: if request.auth != null && 
          request.resource.data.userId == request.auth.uid;
        allow update: if request.auth != null && 
          request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.admins;
        allow delete: if request.auth != null && 
          (request.auth.uid == resource.data.userId ||
           request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.admins);
      }
    }

    // Reports collection
    match /reports/{reportId} {
      allow read: if isAdmin();
      allow create: if request.auth != null;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Audit logs collection
    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow create: if request.auth != null;
      allow update: if false; // Audit logs should never be updated
      allow delete: if isAdmin();
    }

    // Typing indicators collection
    match /typing/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // Pinned messages collection (if used as separate collection)
    match /pinnedMessages/{messageId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      allow delete: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }
  }
}

