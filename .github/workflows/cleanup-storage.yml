# GitHub Actions workflow to automatically delete files older than 24 hours
# Runs daily at midnight UTC

name: Cleanup Old Storage Files

on:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Setup Firebase Service Account
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_CAMPUS_CONNECT_SISTC }}
      
      - name: Install Firebase Admin SDK
        run: npm install firebase-admin --save
      
      - name: Create cleanup script
        run: |
          cat > cleanup.cjs << 'EOF'
          const admin = require('firebase-admin');
          admin.initializeApp({
            credential: admin.credential.applicationDefault(),
            storageBucket: 'campus-connect-sistc.firebasestorage.app'
          });
          
          const storage = admin.storage();
          const bucket = storage.bucket();
          const now = Date.now();
          const twentyFourHoursAgo = now - (24 * 60 * 60 * 1000);
          
          let deletedCount = 0;
          let errorCount = 0;
          
          async function cleanup() {
            const folders = ['messages/', 'profile-pictures/', 'group-files/', 'private-chat-files/'];
            
            console.log('Starting cleanup of files older than 24 hours...');
            console.log(`Current time: ${new Date(now).toISOString()}`);
            console.log(`Deleting files created before: ${new Date(twentyFourHoursAgo).toISOString()}`);
            
            for (const folder of folders) {
              try {
                console.log(`\nChecking ${folder}...`);
                const [files] = await bucket.getFiles({ prefix: folder });
                console.log(`Found ${files.length} files in ${folder}`);
                
                for (const file of files) {
                  try {
                    const [metadata] = await file.getMetadata();
                    const created = new Date(metadata.timeCreated).getTime();
                    const fileSize = parseInt(metadata.size || 0);
                    const fiveMB = 5 * 1024 * 1024; // 5MB in bytes
                    
                    // Delete only files that are BOTH older than 24 hours AND larger than 5MB
                    if (created < twentyFourHoursAgo && fileSize > fiveMB) {
                      await file.delete();
                      deletedCount++;
                      console.log(`  ✓ Deleted: ${file.name} (${(fileSize / 1024 / 1024).toFixed(2)}MB, created: ${new Date(created).toISOString()})`);
                    } else if (created < twentyFourHoursAgo) {
                      console.log(`  - Keeping: ${file.name} (${(fileSize / 1024 / 1024).toFixed(2)}MB - too small to delete)`);
                    }
                  } catch (error) {
                    errorCount++;
                    console.error(`  ✗ Error: ${file.name} - ${error.message}`);
                  }
                }
              } catch (error) {
                console.error(`Error checking ${folder}:`, error.message);
              }
            }
            
            console.log(`\n✅ Cleanup complete! Deleted: ${deletedCount}, Errors: ${errorCount}`);
          }
          
          cleanup().then(() => process.exit(0)).catch(err => {
            console.error('Fatal error:', err);
            process.exit(1);
          });
          EOF
      
      - name: Run cleanup script
        run: node cleanup.cjs

